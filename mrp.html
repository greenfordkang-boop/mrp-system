<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MRP ÏÉùÏÇ∞Í≥ÑÌöç Î∂ÑÏÑù ÏãúÏä§ÌÖú v6</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <style>
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .gradient-header { background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%); }
    </style>
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // Supabase ÏÑ§Ï†ï
        const SUPABASE_URL = 'https://vnhjfbcufmbbhwevzunc.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZuaGpmYmN1Zm1iYmh3ZXZ6dW5jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5MzE2NDEsImV4cCI6MjA4NTUwNzY0MX0.ZZFMYH172ByFDOpBNH_4ehsDNoKMqmLIvdhiCv_27Zo';

        let supabaseClient = null;
        const initSupabase = () => {
            if (window.supabase && typeof window.supabase.createClient === 'function') {
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                return true;
            }
            return false;
        };
        initSupabase();

        // ÏïÑÏù¥ÏΩò Ïª¥Ìè¨ÎÑåÌä∏
        const Icons = {
            Search: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>,
            Download: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>,
            ChevronUp: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 15l7-7 7 7" /></svg>,
            ChevronDown: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" /></svg>,
            X: () => <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" /></svg>,
            Zap: () => <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>,
            SortAsc: () => <svg className="w-3 h-3 inline ml-1" fill="currentColor" viewBox="0 0 20 20"><path d="M5 10l5-5 5 5H5z"/></svg>,
            SortDesc: () => <svg className="w-3 h-3 inline ml-1" fill="currentColor" viewBox="0 0 20 20"><path d="M5 10l5 5 5-5H5z"/></svg>
        };

        // Ï†ïÎ†¨ ÏïÑÏù¥ÏΩò Ïª¥Ìè¨ÎÑåÌä∏
        const SortIcon = ({ field, currentField, direction }) => {
            if (field !== currentField) return <span className="text-gray-300 ml-1">‚Üï</span>;
            return direction === 'asc' ? <Icons.SortAsc /> : <Icons.SortDesc />;
        };

        // ÏÉÅÌÉú Î∞∞ÏßÄ Ïª¥Ìè¨ÎÑåÌä∏
        const StatusBadge = ({ status }) => {
            const styles = {
                full: 'bg-green-100 text-green-700',
                partial: 'bg-yellow-100 text-yellow-700',
                none: 'bg-red-100 text-red-700'
            };
            const labels = { full: 'ÏÉùÏÇ∞Í∞ÄÎä•', partial: 'ÏùºÎ∂ÄÍ∞ÄÎä•', none: 'ÏÉùÏÇ∞Î∂àÍ∞Ä' };
            return <span className={`px-2 py-1 rounded text-xs font-medium ${styles[status]}`}>{labels[status]}</span>;
        };

        // ========== Í∏¥Í∏âÏò§Îçî ÏÉùÏÇ∞Í∞ÄÎä•Ï°∞Ìöå Ïª¥Ìè¨ÎÑåÌä∏ ==========
        function UrgentOrderCheck({ salesPlan, bomRelations, inventory }) {
            const [partNo, setPartNo] = useState('');
            const [productName, setProductName] = useState('');
            const [orderQty, setOrderQty] = useState('');
            const [result, setResult] = useState(null);
            const [loading, setLoading] = useState(false);
            const [showLevel1Detail, setShowLevel1Detail] = useState(false);
            const [showAllLevelDetail, setShowAllLevelDetail] = useState(false);
            const [nameSearchResults, setNameSearchResults] = useState([]);
            const [isExpanded, setIsExpanded] = useState(true);

            // Î†àÎ≤®1 ÌïÑÌÑ∞/Ï†ïÎ†¨
            const [level1Search, setLevel1Search] = useState('');
            const [level1SortField, setLevel1SortField] = useState('partNo');
            const [level1SortDir, setLevel1SortDir] = useState('asc');

            // Ï†ÑÏ≤¥Î†àÎ≤® ÌïÑÌÑ∞/Ï†ïÎ†¨
            const [allLevelSearch, setAllLevelSearch] = useState('');
            const [allLevelSortField, setAllLevelSortField] = useState('shortage');
            const [allLevelSortDir, setAllLevelSortDir] = useState('desc');

            const handleSort = (field, currentField, setField, currentDir, setDir) => {
                if (currentField === field) setDir(currentDir === 'asc' ? 'desc' : 'asc');
                else { setField(field); setDir('asc'); }
            };

            const filterAndSort = (data, search, sortField, sortDir) => {
                let filtered = [...data];
                if (search) {
                    const term = search.toLowerCase();
                    filtered = filtered.filter(m => m.partNo?.toLowerCase().includes(term) || m.partName?.toLowerCase().includes(term));
                }
                filtered.sort((a, b) => {
                    let aVal = a[sortField], bVal = b[sortField];
                    if (typeof aVal === 'string') { aVal = aVal?.toLowerCase(); bVal = bVal?.toLowerCase(); }
                    if (aVal < bVal) return sortDir === 'asc' ? -1 : 1;
                    if (aVal > bVal) return sortDir === 'asc' ? 1 : -1;
                    return 0;
                });
                return filtered;
            };

            const findByPartNo = (searchTerm) => {
                const term = searchTerm.toLowerCase().trim();
                return salesPlan.find(p => p.partNo?.toLowerCase() === term || p.customerPN?.toLowerCase() === term);
            };

            const searchByName = (searchTerm) => {
                const term = searchTerm.toLowerCase().trim();
                if (term.length < 2) return [];
                return salesPlan.filter(p => p.productName?.toLowerCase().includes(term)).slice(0, 10);
            };

            const handleNameChange = (value) => {
                setProductName(value);
                setPartNo('');
                setNameSearchResults(value.length >= 2 ? searchByName(value) : []);
            };

            const selectFromNameSearch = (item) => {
                setPartNo(item.partNo);
                setProductName(item.productName);
                setNameSearchResults([]);
            };

            const expandBomAllLevels = (parentPn, parentQty, visited = new Set()) => {
                if (visited.has(parentPn) || !bomRelations[parentPn]) return [];
                visited.add(parentPn);
                let allMaterials = [];
                (bomRelations[parentPn] || []).forEach(child => {
                    const totalRequired = parentQty * child.qty;
                    const stock = inventory[child.childPn] || 0;
                    allMaterials.push({
                        partNo: child.childPn, partName: child.childName || child.childPn,
                        level: child.level, usage: child.qty, totalRequired, stockQty: stock,
                        shortage: Math.max(0, totalRequired - stock), supplier: child.supplier || '(ÎØ∏ÏßÄÏ†ï)',
                        hasSubBom: !!bomRelations[child.childPn]
                    });
                    const subMaterials = expandBomAllLevels(child.childPn, totalRequired, new Set(visited));
                    allMaterials.push(...subMaterials);
                });
                return allMaterials;
            };

            const handleCheck = () => {
                if (!partNo || !orderQty) return;
                setLoading(true);
                setTimeout(() => {
                    const qty = parseInt(orderQty);
                    const product = findByPartNo(partNo);
                    if (!product) { setResult({ error: 'Ï†úÌíàÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.' }); setLoading(false); return; }

                    const level1Children = (bomRelations[partNo] || []).filter(c => c.level === 1);
                    const level1Materials = level1Children.map(child => {
                        const required = qty * child.qty;
                        const stock = inventory[child.childPn] || 0;
                        return {
                            partNo: child.childPn, partName: child.childName || child.childPn,
                            usage: child.qty, required, stock, shortage: Math.max(0, required - stock),
                            possible: child.qty > 0 ? Math.floor(stock / child.qty) : 0,
                            hasBom: !!bomRelations[child.childPn], supplier: child.supplier || '(ÎØ∏ÏßÄÏ†ï)'
                        };
                    });
                    const level1PossibleQty = level1Materials.length > 0 ? Math.min(...level1Materials.map(m => m.possible)) : qty;

                    const allLevelMaterials = expandBomAllLevels(partNo, qty, new Set());
                    const allLevelPossibleQty = allLevelMaterials.length > 0
                        ? Math.min(...allLevelMaterials.map(m => m.stockQty >= m.totalRequired ? qty : Math.floor(m.stockQty / (m.totalRequired / qty) || 0)))
                        : qty;

                    setResult({
                        product, orderQty: qty,
                        level1Analysis: { materials: level1Materials, possibleQty: Math.max(0, level1PossibleQty), shortageCount: level1Materials.filter(m => m.shortage > 0).length, materialCount: level1Materials.length },
                        allLevelAnalysis: { materials: allLevelMaterials, possibleQty: Math.max(0, allLevelPossibleQty), shortageCount: allLevelMaterials.filter(m => m.shortage > 0).length, materialCount: allLevelMaterials.length }
                    });
                    setLoading(false);
                }, 300);
            };

            const exportLevel1Excel = () => {
                if (!result?.level1Analysis?.materials) return;
                const data = filterAndSort(result.level1Analysis.materials, level1Search, level1SortField, level1SortDir).map(m => ({
                    'ÏûêÏû¨ÏΩîÎìú': m.partNo, 'ÏûêÏû¨Î™Ö': m.partName, 'ÌòëÎ†•ÏÇ¨': m.supplier,
                    'Îã®ÏúÑÏàòÎüâ': m.usage, 'ÏÜåÏöîÎüâ': m.required, 'Ïû¨Í≥†': m.stock, 'Í≥ºÎ∂ÄÏ°±': m.shortage > 0 ? -m.shortage : 0
                }));
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Î†àÎ≤®1ÏûêÏû¨');
                XLSX.writeFile(wb, 'Í∏¥Í∏âÏò§Îçî_Î†àÎ≤®1ÏûêÏû¨.xlsx');
            };

            const exportAllLevelExcel = () => {
                if (!result?.allLevelAnalysis?.materials) return;
                const data = filterAndSort(result.allLevelAnalysis.materials.filter(m => m.shortage > 0), allLevelSearch, allLevelSortField, allLevelSortDir).map(m => ({
                    'ÏûêÏû¨ÏΩîÎìú': m.partNo, 'ÏûêÏû¨Î™Ö': m.partName, 'Î†àÎ≤®': m.level, 'ÌòëÎ†•ÏÇ¨': m.supplier,
                    'ÏÜåÏöîÎüâ': m.totalRequired, 'Ïû¨Í≥†': m.stockQty, 'Î∂ÄÏ°±Îüâ': m.shortage
                }));
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Ï†ÑÏ≤¥Î†àÎ≤®Î∂ÄÏ°±ÏûêÏû¨');
                XLSX.writeFile(wb, 'Í∏¥Í∏âÏò§Îçî_Ï†ÑÏ≤¥Î†àÎ≤®Î∂ÄÏ°±ÏûêÏû¨.xlsx');
            };

            const clearForm = () => { setPartNo(''); setProductName(''); setOrderQty(''); setResult(null); setNameSearchResults([]); };

            return (
                <div className="bg-gradient-to-br from-indigo-50 to-purple-50 rounded-2xl shadow-lg border border-indigo-100 mb-6 overflow-hidden">
                    <div className="p-4 bg-indigo-100/50 flex items-center justify-between cursor-pointer" onClick={() => setIsExpanded(!isExpanded)}>
                        <div className="flex items-center gap-3">
                            <div className="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center text-white"><Icons.Zap /></div>
                            <div>
                                <h2 className="text-lg font-bold text-indigo-900">Í∏¥Í∏â Ïò§Îçî ÏÉùÏÇ∞Í∞ÄÎä• Ï°∞Ìöå</h2>
                                <p className="text-sm text-indigo-600">Î†àÎ≤®1 / Ï†ÑÏ≤¥Î†àÎ≤® Í∏∞Ï§Ä ÏÉùÏÇ∞Í∞ÄÎä• ÏàòÎüâ ÎπÑÍµê</p>
                            </div>
                        </div>
                        <div className="flex items-center gap-4">
                            <div className="flex items-center gap-2 text-xs">
                                <span className="w-3 h-3 rounded bg-blue-500"></span> Î†àÎ≤®1
                                <span className="w-3 h-3 rounded bg-purple-500 ml-2"></span> Ï†ÑÏ≤¥Î†àÎ≤®
                            </div>
                            {isExpanded ? <Icons.ChevronUp /> : <Icons.ChevronDown />}
                        </div>
                    </div>

                    {isExpanded && (
                        <div className="p-6">
                            <div className="grid grid-cols-1 md:grid-cols-12 gap-4 mb-4 items-end">
                                <div className="md:col-span-3">
                                    <label className="block text-sm font-medium text-gray-700 mb-1">ÌíàÎ≤à / Í≥†Í∞ùÏÇ¨ P/N</label>
                                    <input type="text" value={partNo} onChange={e => setPartNo(e.target.value)} placeholder="ÌíàÎ≤à ÏûÖÎ†•"
                                        className="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent" />
                                </div>
                                <div className="md:col-span-1 text-center text-gray-400 font-medium">OR</div>
                                <div className="md:col-span-4 relative">
                                    <label className="block text-sm font-medium text-gray-700 mb-1">ÌíàÎ™Ö Í≤ÄÏÉâ</label>
                                    <input type="text" value={productName} onChange={e => handleNameChange(e.target.value)} placeholder="ÌíàÎ™Ö ÏûÖÎ†• (2Ïûê Ïù¥ÏÉÅ)"
                                        className="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent" />
                                    {nameSearchResults.length > 0 && (
                                        <div className="absolute z-20 w-full bg-white border rounded-xl shadow-lg mt-1 max-h-60 overflow-auto">
                                            {nameSearchResults.map((item, idx) => (
                                                <div key={idx} onClick={() => selectFromNameSearch(item)} className="px-4 py-3 hover:bg-indigo-50 cursor-pointer border-b">
                                                    <div className="font-medium text-gray-800">{item.productName}</div>
                                                    <div className="text-xs text-gray-500">{item.partNo}</div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                                <div className="md:col-span-2">
                                    <label className="block text-sm font-medium text-gray-700 mb-1">Ïò§Îçî ÏàòÎüâ <span className="text-red-500">*</span></label>
                                    <input type="number" value={orderQty} onChange={e => setOrderQty(e.target.value)} placeholder="ÏàòÎüâ"
                                        className="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-transparent" />
                                </div>
                                <div className="md:col-span-2 flex gap-2">
                                    <button onClick={handleCheck} disabled={loading || !partNo || !orderQty}
                                        className="flex-1 px-6 py-3 bg-indigo-600 text-white rounded-xl font-medium flex items-center justify-center gap-2 hover:bg-indigo-700 disabled:opacity-50 transition-colors">
                                        üîç Ï°∞Ìöå
                                    </button>
                                    {(partNo || productName || orderQty) && (
                                        <button onClick={clearForm} className="px-3 py-3 text-gray-500 hover:text-gray-700"><Icons.X /></button>
                                    )}
                                </div>
                            </div>

                            {!result && (
                                <div className="bg-gray-50 rounded-xl p-8 text-center">
                                    <div className="w-16 h-16 bg-gray-200 rounded-full flex items-center justify-center mx-auto mb-4"><span className="text-2xl">üîí</span></div>
                                    <p className="text-gray-600 font-medium mb-2">ÌíàÎ≤à/ÌíàÎ™ÖÍ≥º ÏàòÎüâÏùÑ ÏûÖÎ†•ÌïòÏÑ∏Ïöî</p>
                                </div>
                            )}

                            {result && !result.error && (
                                <div className="space-y-4 fade-in">
                                    <div className="grid grid-cols-2 gap-4">
                                        <div className="bg-gradient-to-br from-blue-100 to-blue-200 rounded-xl p-5">
                                            <p className="text-sm text-blue-700 mb-1">Î†àÎ≤®1 ÏßÅÏ†ëÏûêÏû¨ Í∏∞Ï§Ä</p>
                                            <p className="text-4xl font-bold text-blue-800">{result.level1Analysis.possibleQty.toLocaleString()}<span className="text-lg">Í∞ú</span></p>
                                            <p className="text-sm text-blue-600 mt-2">Î∂ÄÏ°±ÏûêÏû¨ <span className="font-bold text-red-600">{result.level1Analysis.shortageCount}Ï¢Ö</span> / Ï†ÑÏ≤¥ {result.level1Analysis.materialCount}Ï¢Ö</p>
                                        </div>
                                        <div className="bg-gradient-to-br from-purple-100 to-purple-200 rounded-xl p-5">
                                            <p className="text-sm text-purple-700 mb-1">Ï†ÑÏ≤¥Î†àÎ≤® BOMÏ†ÑÍ∞ú Í∏∞Ï§Ä</p>
                                            <p className="text-4xl font-bold text-purple-800">{result.allLevelAnalysis.possibleQty.toLocaleString()}<span className="text-lg">Í∞ú</span></p>
                                            <p className="text-sm text-purple-600 mt-2">Î∂ÄÏ°±ÏûêÏû¨ <span className="font-bold text-red-600">{result.allLevelAnalysis.shortageCount}Ï¢Ö</span> / Ï†ÑÏ≤¥ {result.allLevelAnalysis.materialCount}Ï¢Ö</p>
                                        </div>
                                    </div>

                                    {/* Î†àÎ≤®1 ÏÉÅÏÑ∏ - Ï†ëÍ∏∞/ÌéºÏπòÍ∏∞ + ÌïÑÌÑ∞/Ï†ïÎ†¨ + Îã§Ïö¥Î°úÎìú */}
                                    <div className="bg-white rounded-xl shadow">
                                        <div className="p-4 border-b cursor-pointer flex justify-between items-center" onClick={() => setShowLevel1Detail(!showLevel1Detail)}>
                                            <span className="font-bold text-blue-800">üì¶ Î†àÎ≤®1 ÏßÅÏ†ëÏûêÏû¨ ÌòÑÌô© ({result.level1Analysis.materialCount}Ï¢Ö)</span>
                                            <span>{showLevel1Detail ? '‚ñ≤' : '‚ñº'}</span>
                                        </div>
                                        {showLevel1Detail && (
                                            <div className="p-4">
                                                <div className="flex gap-2 mb-3 flex-wrap">
                                                    <div className="relative flex-1 min-w-[200px]">
                                                        <input type="text" placeholder="ÏûêÏû¨ÏΩîÎìú, ÏûêÏû¨Î™Ö Í≤ÄÏÉâ..." value={level1Search} onChange={e => setLevel1Search(e.target.value)}
                                                            className="w-full pl-9 pr-4 py-2 border rounded-lg text-sm" />
                                                        <div className="absolute left-3 top-2.5 text-gray-400"><Icons.Search /></div>
                                                    </div>
                                                    <button onClick={exportLevel1Excel} className="px-3 py-2 bg-green-600 text-white rounded-lg text-sm flex items-center gap-1 hover:bg-green-700">
                                                        <Icons.Download /> Excel
                                                    </button>
                                                </div>
                                                <div className="overflow-x-auto max-h-64 overflow-y-auto">
                                                    <table className="w-full text-sm">
                                                        <thead className="bg-blue-50 sticky top-0">
                                                            <tr>
                                                                <th className="px-3 py-2 text-left cursor-pointer hover:bg-blue-100" onClick={() => handleSort('partNo', level1SortField, setLevel1SortField, level1SortDir, setLevel1SortDir)}>ÏûêÏû¨ÏΩîÎìú <SortIcon field="partNo" currentField={level1SortField} direction={level1SortDir} /></th>
                                                                <th className="px-3 py-2 text-left cursor-pointer hover:bg-blue-100" onClick={() => handleSort('partName', level1SortField, setLevel1SortField, level1SortDir, setLevel1SortDir)}>ÏûêÏû¨Î™Ö <SortIcon field="partName" currentField={level1SortField} direction={level1SortDir} /></th>
                                                                <th className="px-3 py-2 text-center">ÌïòÏúÑBOM</th>
                                                                <th className="px-3 py-2 text-right cursor-pointer hover:bg-blue-100" onClick={() => handleSort('usage', level1SortField, setLevel1SortField, level1SortDir, setLevel1SortDir)}>Îã®ÏúÑÏàòÎüâ <SortIcon field="usage" currentField={level1SortField} direction={level1SortDir} /></th>
                                                                <th className="px-3 py-2 text-right cursor-pointer hover:bg-blue-100" onClick={() => handleSort('required', level1SortField, setLevel1SortField, level1SortDir, setLevel1SortDir)}>ÏÜåÏöîÎüâ <SortIcon field="required" currentField={level1SortField} direction={level1SortDir} /></th>
                                                                <th className="px-3 py-2 text-right cursor-pointer hover:bg-blue-100" onClick={() => handleSort('stock', level1SortField, setLevel1SortField, level1SortDir, setLevel1SortDir)}>Ïû¨Í≥† <SortIcon field="stock" currentField={level1SortField} direction={level1SortDir} /></th>
                                                                <th className="px-3 py-2 text-right cursor-pointer hover:bg-blue-100" onClick={() => handleSort('shortage', level1SortField, setLevel1SortField, level1SortDir, setLevel1SortDir)}>Í≥ºÎ∂ÄÏ°± <SortIcon field="shortage" currentField={level1SortField} direction={level1SortDir} /></th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            {filterAndSort(result.level1Analysis.materials, level1Search, level1SortField, level1SortDir).map((m, idx) => (
                                                                <tr key={idx} className={m.shortage > 0 ? 'bg-red-50' : 'bg-green-50'}>
                                                                    <td className="px-3 py-2 font-mono">{m.partNo}</td>
                                                                    <td className="px-3 py-2">{m.partName}</td>
                                                                    <td className="px-3 py-2 text-center">{m.hasBom ? 'üîó' : '-'}</td>
                                                                    <td className="px-3 py-2 text-right">{m.usage}</td>
                                                                    <td className="px-3 py-2 text-right">{m.required?.toLocaleString()}</td>
                                                                    <td className="px-3 py-2 text-right">{m.stock?.toLocaleString()}</td>
                                                                    <td className={`px-3 py-2 text-right font-bold ${m.shortage > 0 ? 'text-red-600' : 'text-green-600'}`}>
                                                                        {m.shortage > 0 ? `-${m.shortage.toLocaleString()}` : '‚úì'}
                                                                    </td>
                                                                </tr>
                                                            ))}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        )}
                                    </div>

                                    {/* Ï†ÑÏ≤¥Î†àÎ≤® Î∂ÄÏ°±ÏûêÏû¨ - Ï†ëÍ∏∞/ÌéºÏπòÍ∏∞ + ÌïÑÌÑ∞/Ï†ïÎ†¨ + Îã§Ïö¥Î°úÎìú */}
                                    {result.allLevelAnalysis.shortageCount > 0 && (
                                        <div className="bg-white rounded-xl shadow">
                                            <div className="p-4 border-b cursor-pointer flex justify-between items-center" onClick={() => setShowAllLevelDetail(!showAllLevelDetail)}>
                                                <span className="font-bold text-red-800">‚ö†Ô∏è Ï†ÑÏ≤¥ Î†àÎ≤® Î∂ÄÏ°±ÏûêÏû¨ ÏÉÅÏÑ∏ ({result.allLevelAnalysis.shortageCount}Ï¢Ö)</span>
                                                <span>{showAllLevelDetail ? '‚ñ≤' : '‚ñº'}</span>
                                            </div>
                                            {showAllLevelDetail && (
                                                <div className="p-4">
                                                    <div className="flex gap-2 mb-3 flex-wrap">
                                                        <div className="relative flex-1 min-w-[200px]">
                                                            <input type="text" placeholder="ÏûêÏû¨ÏΩîÎìú, ÏûêÏû¨Î™Ö Í≤ÄÏÉâ..." value={allLevelSearch} onChange={e => setAllLevelSearch(e.target.value)}
                                                                className="w-full pl-9 pr-4 py-2 border rounded-lg text-sm" />
                                                            <div className="absolute left-3 top-2.5 text-gray-400"><Icons.Search /></div>
                                                        </div>
                                                        <button onClick={exportAllLevelExcel} className="px-3 py-2 bg-green-600 text-white rounded-lg text-sm flex items-center gap-1 hover:bg-green-700">
                                                            <Icons.Download /> Excel
                                                        </button>
                                                    </div>
                                                    <div className="overflow-x-auto max-h-64 overflow-y-auto">
                                                        <table className="w-full text-sm">
                                                            <thead className="bg-red-50 sticky top-0">
                                                                <tr>
                                                                    <th className="px-3 py-2 text-left cursor-pointer hover:bg-red-100" onClick={() => handleSort('partNo', allLevelSortField, setAllLevelSortField, allLevelSortDir, setAllLevelSortDir)}>ÏûêÏû¨ÏΩîÎìú <SortIcon field="partNo" currentField={allLevelSortField} direction={allLevelSortDir} /></th>
                                                                    <th className="px-3 py-2 text-left cursor-pointer hover:bg-red-100" onClick={() => handleSort('partName', allLevelSortField, setAllLevelSortField, allLevelSortDir, setAllLevelSortDir)}>ÏûêÏû¨Î™Ö <SortIcon field="partName" currentField={allLevelSortField} direction={allLevelSortDir} /></th>
                                                                    <th className="px-3 py-2 text-center cursor-pointer hover:bg-red-100" onClick={() => handleSort('level', allLevelSortField, setAllLevelSortField, allLevelSortDir, setAllLevelSortDir)}>Î†àÎ≤® <SortIcon field="level" currentField={allLevelSortField} direction={allLevelSortDir} /></th>
                                                                    <th className="px-3 py-2 text-left cursor-pointer hover:bg-red-100" onClick={() => handleSort('supplier', allLevelSortField, setAllLevelSortField, allLevelSortDir, setAllLevelSortDir)}>ÌòëÎ†•ÏÇ¨ <SortIcon field="supplier" currentField={allLevelSortField} direction={allLevelSortDir} /></th>
                                                                    <th className="px-3 py-2 text-right cursor-pointer hover:bg-red-100" onClick={() => handleSort('totalRequired', allLevelSortField, setAllLevelSortField, allLevelSortDir, setAllLevelSortDir)}>ÏÜåÏöîÎüâ <SortIcon field="totalRequired" currentField={allLevelSortField} direction={allLevelSortDir} /></th>
                                                                    <th className="px-3 py-2 text-right cursor-pointer hover:bg-red-100" onClick={() => handleSort('stockQty', allLevelSortField, setAllLevelSortField, allLevelSortDir, setAllLevelSortDir)}>Ïû¨Í≥† <SortIcon field="stockQty" currentField={allLevelSortField} direction={allLevelSortDir} /></th>
                                                                    <th className="px-3 py-2 text-right cursor-pointer hover:bg-red-100" onClick={() => handleSort('shortage', allLevelSortField, setAllLevelSortField, allLevelSortDir, setAllLevelSortDir)}>Î∂ÄÏ°±Îüâ <SortIcon field="shortage" currentField={allLevelSortField} direction={allLevelSortDir} /></th>
                                                                </tr>
                                                            </thead>
                                                            <tbody>
                                                                {filterAndSort(result.allLevelAnalysis.materials.filter(m => m.shortage > 0), allLevelSearch, allLevelSortField, allLevelSortDir).map((m, idx) => (
                                                                    <tr key={idx} className="bg-red-50 hover:bg-red-100">
                                                                        <td className="px-3 py-2 font-mono">{m.partNo}</td>
                                                                        <td className="px-3 py-2">{m.partName}</td>
                                                                        <td className="px-3 py-2 text-center">L{m.level}</td>
                                                                        <td className="px-3 py-2">{m.supplier}</td>
                                                                        <td className="px-3 py-2 text-right">{m.totalRequired?.toLocaleString()}</td>
                                                                        <td className="px-3 py-2 text-right">{m.stockQty?.toLocaleString()}</td>
                                                                        <td className="px-3 py-2 text-right font-bold text-red-600">-{m.shortage?.toLocaleString()}</td>
                                                                    </tr>
                                                                ))}
                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    )}
                                </div>
                            )}

                            {result?.error && <div className="bg-red-50 border border-red-200 rounded-xl p-4 text-red-700">{result.error}</div>}
                        </div>
                    )}
                </div>
            );
        }

        // ========== ÏòÅÏóÖÍ≥ÑÌöç Ï†úÌíà ÏÑ†ÌÉù Ïª¥Ìè¨ÎÑåÌä∏ ==========
        function SalesPlanSelection({ salesPlan, onSelectionChange, selectedParts, mrpResults, onAnalyze, showAnalysisButton }) {
            const [searchTerm, setSearchTerm] = useState('');
            const [customerFilter, setCustomerFilter] = useState('Ï†ÑÏ≤¥');
            const [isExpanded, setIsExpanded] = useState(true);

            const customers = useMemo(() => {
                const list = [...new Set(salesPlan.map(item => item.customerName).filter(Boolean))];
                return ['Ï†ÑÏ≤¥', ...list.sort()];
            }, [salesPlan]);

            const filteredSales = useMemo(() => {
                return salesPlan.filter(item => {
                    const matchSearch = !searchTerm ||
                        item.partNo?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        item.productName?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                        item.customerPN?.toLowerCase().includes(searchTerm.toLowerCase());
                    const matchCustomer = customerFilter === 'Ï†ÑÏ≤¥' || item.customerName === customerFilter;
                    return matchSearch && matchCustomer;
                });
            }, [salesPlan, searchTerm, customerFilter]);

            const toggleSelection = (partNo) => {
                const newSelection = selectedParts.includes(partNo)
                    ? selectedParts.filter(p => p !== partNo)
                    : [...selectedParts, partNo];
                onSelectionChange(newSelection);
            };

            const selectAll = () => onSelectionChange(filteredSales.map(item => item.partNo));
            const clearSelection = () => onSelectionChange([]);

            return (
                <div className="bg-white rounded-2xl shadow-lg overflow-hidden mb-6">
                    <div className="p-4 bg-gray-50 flex items-center justify-between cursor-pointer" onClick={() => setIsExpanded(!isExpanded)}>
                        <div className="flex items-center gap-2">
                            <span className="w-6 h-6 bg-blue-500 text-white rounded-full flex items-center justify-center text-sm font-bold">1</span>
                            <h2 className="text-lg font-bold text-gray-800">ÏòÅÏóÖÍ≥ÑÌöç Ï°∞Ìöå - Î∂ÑÏÑùÌï† Ï†úÌíà ÏÑ†ÌÉù</h2>
                            <span className="text-sm text-blue-600 font-medium ml-2">{selectedParts.length}Í±¥ ÏÑ†ÌÉùÎê®</span>
                        </div>
                        {isExpanded ? <Icons.ChevronUp /> : <Icons.ChevronDown />}
                    </div>

                    {isExpanded && (
                        <div className="p-6">
                            <div className="flex gap-4 mb-4 flex-wrap">
                                <div className="flex-1 min-w-[200px] relative">
                                    <input type="text" placeholder="ÌíàÎ≤à, Ï†úÌíàÎ™Ö, Í≥†Í∞ùÏÇ¨ P/N Í≤ÄÏÉâ..." value={searchTerm}
                                        onChange={e => setSearchTerm(e.target.value)}
                                        className="w-full pl-10 pr-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500" />
                                    <div className="absolute left-3 top-3.5 text-gray-400"><Icons.Search /></div>
                                </div>
                                <select value={customerFilter} onChange={e => setCustomerFilter(e.target.value)}
                                    className="px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-blue-500 min-w-[150px]">
                                    {customers.map(c => <option key={c} value={c}>{c}</option>)}
                                </select>
                                <button onClick={selectAll} className="px-4 py-3 border-2 border-blue-500 text-blue-600 rounded-xl font-medium hover:bg-blue-50">Ï†ÑÏ≤¥ ÏÑ†ÌÉù</button>
                                <button onClick={clearSelection} className="px-4 py-3 border border-gray-300 text-gray-600 rounded-xl font-medium hover:bg-gray-50">ÏÑ†ÌÉù Ìï¥Ï†ú</button>
                            </div>

                            <div className="border rounded-xl overflow-hidden max-h-[400px] overflow-y-auto">
                                <table className="w-full">
                                    <thead className="bg-gray-50 sticky top-0">
                                        <tr>
                                            <th className="px-4 py-3 text-left w-12">
                                                <input type="checkbox" checked={selectedParts.length === filteredSales.length && filteredSales.length > 0}
                                                    onChange={() => selectedParts.length === filteredSales.length ? clearSelection() : selectAll()}
                                                    className="w-5 h-5 rounded border-gray-300 text-blue-600" />
                                            </th>
                                            <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">ÌíàÎ≤à</th>
                                            <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">Ï†úÌíàÎ™Ö</th>
                                            <th className="px-4 py-3 text-left text-sm font-medium text-gray-600">Í≥†Í∞ùÏÇ¨</th>
                                            <th className="px-4 py-3 text-right text-sm font-medium text-gray-600">Í≥ÑÌöçÏàòÎüâ</th>
                                            <th className="px-4 py-3 text-center text-sm font-medium text-gray-600">ÏÉÅÌÉú</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y">
                                        {filteredSales.map((item, idx) => {
                                            const result = mrpResults[item.partNo];
                                            return (
                                                <tr key={idx} className={`hover:bg-gray-50 cursor-pointer ${selectedParts.includes(item.partNo) ? 'bg-blue-50' : ''}`} onClick={() => toggleSelection(item.partNo)}>
                                                    <td className="px-4 py-3">
                                                        <input type="checkbox" checked={selectedParts.includes(item.partNo)} onChange={() => {}}
                                                            className="w-5 h-5 rounded border-gray-300 text-blue-600" />
                                                    </td>
                                                    <td className="px-4 py-3">
                                                        <div className="font-mono text-sm">{item.partNo}</div>
                                                        <div className="text-xs text-gray-400">{item.customerPN}</div>
                                                    </td>
                                                    <td className="px-4 py-3 text-gray-700">{item.productName}</td>
                                                    <td className="px-4 py-3 text-gray-600">{item.customerName}</td>
                                                    <td className="px-4 py-3 text-right font-medium">{item.orderQty?.toLocaleString()}</td>
                                                    <td className="px-4 py-3 text-center">{result && <StatusBadge status={result.status} />}</td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>

                            {/* ÌïòÎã®: ÏÑ†ÌÉù Í±¥Ïàò + Î∂ÑÏÑù Í≤∞Í≥º Î≥¥Í∏∞ Î≤ÑÌäº */}
                            {selectedParts.length > 0 && (
                                <div className="mt-6 pt-4 border-t flex items-center justify-between">
                                    <div className="text-blue-600 font-medium">
                                        <span className="text-lg font-bold">{selectedParts.length}</span>Í±¥ ÏÑ†ÌÉùÎê®
                                    </div>
                                    <button onClick={onAnalyze}
                                        className="px-8 py-3 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-xl font-bold shadow-lg hover:from-blue-700 hover:to-indigo-700 transition-all">
                                        Î∂ÑÏÑù Í≤∞Í≥º Î≥¥Í∏∞
                                    </button>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        }

        // ========== Î∂ÑÏÑù Í≤∞Í≥º Ïª¥Ìè¨ÎÑåÌä∏ (ÌïÑÌÑ∞/Ï†ïÎ†¨/Îã§Ïö¥Î°úÎìú ÏôÑÎπÑ) ==========
        function AnalysisResults({ selectedParts, mrpResults, salesPlan }) {
            const [isExpanded, setIsExpanded] = useState(true);
            const [searchTerm, setSearchTerm] = useState('');
            const [statusFilter, setStatusFilter] = useState('Ï†ÑÏ≤¥');
            const [customerFilter, setCustomerFilter] = useState('Ï†ÑÏ≤¥');
            const [sortField, setSortField] = useState('status');
            const [sortDir, setSortDir] = useState('desc');

            const customers = useMemo(() => {
                const list = [...new Set(salesPlan.map(item => item.customerName).filter(Boolean))];
                return ['Ï†ÑÏ≤¥', ...list.sort()];
            }, [salesPlan]);

            const selectedResults = selectedParts.map(p => mrpResults[p]).filter(Boolean);

            const stats = {
                total: selectedResults.length,
                full: selectedResults.filter(r => r.status === 'full').length,
                partial: selectedResults.filter(r => r.status === 'partial').length,
                none: selectedResults.filter(r => r.status === 'none').length
            };

            const filteredAndSorted = useMemo(() => {
                let filtered = [...selectedResults];
                if (searchTerm) {
                    const term = searchTerm.toLowerCase();
                    filtered = filtered.filter(r => r.partNo?.toLowerCase().includes(term) || r.productName?.toLowerCase().includes(term));
                }
                if (statusFilter !== 'Ï†ÑÏ≤¥') {
                    const statusMap = { 'ÏÉùÏÇ∞Í∞ÄÎä•': 'full', 'ÏùºÎ∂ÄÍ∞ÄÎä•': 'partial', 'ÏÉùÏÇ∞Î∂àÍ∞Ä': 'none' };
                    filtered = filtered.filter(r => r.status === statusMap[statusFilter]);
                }
                if (customerFilter !== 'Ï†ÑÏ≤¥') {
                    filtered = filtered.filter(r => r.customerName === customerFilter);
                }
                filtered.sort((a, b) => {
                    let aVal = a[sortField], bVal = b[sortField];
                    if (typeof aVal === 'string') { aVal = aVal?.toLowerCase(); bVal = bVal?.toLowerCase(); }
                    if (aVal < bVal) return sortDir === 'asc' ? -1 : 1;
                    if (aVal > bVal) return sortDir === 'asc' ? 1 : -1;
                    return 0;
                });
                return filtered;
            }, [selectedResults, searchTerm, statusFilter, customerFilter, sortField, sortDir]);

            const handleSort = (field) => {
                if (sortField === field) setSortDir(sortDir === 'asc' ? 'desc' : 'asc');
                else { setSortField(field); setSortDir('asc'); }
            };

            const exportToExcel = () => {
                const data = filteredAndSorted.map(r => ({
                    'ÌíàÎ≤à': r.partNo, 'ÌíàÎ™Ö': r.productName, 'Í≥†Í∞ùÏÇ¨': r.customerName,
                    'Ï£ºÎ¨∏ÏàòÎüâ': r.orderQty, 'ÏÉùÏÇ∞Í∞ÄÎä•ÏàòÎüâ': r.possibleQty,
                    'Ïª§Î≤ÑÏú®(%)': r.minCoverage, 'Î∂ÄÏ°±ÏàòÎüâ': r.shortageQty,
                    'Î∂ÄÏ°±ÏûêÏû¨Ïàò': r.shortageCount,
                    'ÏÉÅÌÉú': r.status === 'full' ? 'ÏÉùÏÇ∞Í∞ÄÎä•' : r.status === 'partial' ? 'ÏùºÎ∂ÄÍ∞ÄÎä•' : 'ÏÉùÏÇ∞Î∂àÍ∞Ä',
                    'Î∂ÄÏ°±ÏûêÏû¨': r.materials?.filter(m => m.status === 'shortage').map(m => m.partNo).join(', ') || ''
                }));
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'MRPÎ∂ÑÏÑùÍ≤∞Í≥º');
                XLSX.writeFile(wb, 'MRP_Î∂ÑÏÑùÍ≤∞Í≥º.xlsx');
            };

            const clearFilters = () => { setSearchTerm(''); setStatusFilter('Ï†ÑÏ≤¥'); setCustomerFilter('Ï†ÑÏ≤¥'); };

            if (selectedParts.length === 0) return null;

            return (
                <div className="bg-white rounded-2xl shadow-lg overflow-hidden mb-6 fade-in">
                    <div className="p-4 bg-gray-50 flex items-center justify-between cursor-pointer" onClick={() => setIsExpanded(!isExpanded)}>
                        <div className="flex items-center gap-2">
                            <span className="w-6 h-6 bg-green-500 text-white rounded-full flex items-center justify-center text-sm font-bold">2</span>
                            <h2 className="text-lg font-bold text-gray-800">ÏÉùÏÇ∞ Í∞ÄÎä• ÏàòÎüâ Î∂ÑÏÑù Í≤∞Í≥º</h2>
                        </div>
                        <div className="flex items-center gap-2">
                            <button onClick={(e) => { e.stopPropagation(); exportToExcel(); }} className="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm">
                                <Icons.Download /> Excel Îã§Ïö¥Î°úÎìú
                            </button>
                            {isExpanded ? <Icons.ChevronUp /> : <Icons.ChevronDown />}
                        </div>
                    </div>

                    {isExpanded && (
                        <div className="p-6">
                            {/* ÏöîÏïΩ Ïπ¥Îìú - ÌÅ¥Î¶≠Ïãú ÌïÑÌÑ∞ */}
                            <div className="grid grid-cols-4 gap-4 mb-6">
                                <div className="bg-blue-50 rounded-xl p-4 text-center cursor-pointer hover:bg-blue-100 transition-colors" onClick={() => setStatusFilter('Ï†ÑÏ≤¥')}>
                                    <p className="text-sm text-gray-500">Î∂ÑÏÑù ÎåÄÏÉÅ</p>
                                    <p className="text-2xl font-bold text-blue-600">{stats.total}</p>
                                </div>
                                <div className="bg-green-50 rounded-xl p-4 text-center cursor-pointer hover:bg-green-100 transition-colors" onClick={() => setStatusFilter('ÏÉùÏÇ∞Í∞ÄÎä•')}>
                                    <p className="text-sm text-gray-500">ÏÉùÏÇ∞Í∞ÄÎä•</p>
                                    <p className="text-2xl font-bold text-green-600">{stats.full}</p>
                                </div>
                                <div className="bg-yellow-50 rounded-xl p-4 text-center cursor-pointer hover:bg-yellow-100 transition-colors" onClick={() => setStatusFilter('ÏùºÎ∂ÄÍ∞ÄÎä•')}>
                                    <p className="text-sm text-gray-500">ÏùºÎ∂ÄÍ∞ÄÎä•</p>
                                    <p className="text-2xl font-bold text-yellow-600">{stats.partial}</p>
                                </div>
                                <div className="bg-red-50 rounded-xl p-4 text-center cursor-pointer hover:bg-red-100 transition-colors" onClick={() => setStatusFilter('ÏÉùÏÇ∞Î∂àÍ∞Ä')}>
                                    <p className="text-sm text-gray-500">ÏÉùÏÇ∞Î∂àÍ∞Ä</p>
                                    <p className="text-2xl font-bold text-red-600">{stats.none}</p>
                                </div>
                            </div>

                            {/* ÌïÑÌÑ∞ ÏòÅÏó≠ */}
                            <div className="flex gap-4 mb-4 flex-wrap items-center bg-gray-50 p-3 rounded-lg">
                                <div className="flex-1 min-w-[180px] relative">
                                    <input type="text" placeholder="Ï†úÌíàÎ™Ö, ÌíàÎ≤à Í≤ÄÏÉâ..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)}
                                        className="w-full pl-9 pr-4 py-2 border rounded-lg text-sm" />
                                    <div className="absolute left-3 top-2.5 text-gray-400"><Icons.Search /></div>
                                </div>
                                <select value={statusFilter} onChange={e => setStatusFilter(e.target.value)} className="px-3 py-2 border rounded-lg text-sm">
                                    <option value="Ï†ÑÏ≤¥">ÏÉÅÌÉú: Ï†ÑÏ≤¥</option>
                                    <option value="ÏÉùÏÇ∞Í∞ÄÎä•">ÏÉùÏÇ∞Í∞ÄÎä•</option>
                                    <option value="ÏùºÎ∂ÄÍ∞ÄÎä•">ÏùºÎ∂ÄÍ∞ÄÎä•</option>
                                    <option value="ÏÉùÏÇ∞Î∂àÍ∞Ä">ÏÉùÏÇ∞Î∂àÍ∞Ä</option>
                                </select>
                                <select value={customerFilter} onChange={e => setCustomerFilter(e.target.value)} className="px-3 py-2 border rounded-lg text-sm">
                                    {customers.map(c => <option key={c} value={c}>{c === 'Ï†ÑÏ≤¥' ? 'Í≥†Í∞ùÏÇ¨: Ï†ÑÏ≤¥' : c}</option>)}
                                </select>
                                {(searchTerm || statusFilter !== 'Ï†ÑÏ≤¥' || customerFilter !== 'Ï†ÑÏ≤¥') && (
                                    <button onClick={clearFilters} className="px-3 py-2 text-sm text-gray-600 hover:text-gray-800 flex items-center gap-1">
                                        <Icons.X /> ÌïÑÌÑ∞ Ï¥àÍ∏∞Ìôî
                                    </button>
                                )}
                                <span className="text-sm text-gray-500 ml-auto">Í≤ÄÏÉâÍ≤∞Í≥º: <strong className="text-green-600">{filteredAndSorted.length}</strong>Í±¥</span>
                            </div>

                            {/* Í≤∞Í≥º ÌÖåÏù¥Î∏î */}
                            <div className="border rounded-xl overflow-hidden max-h-[400px] overflow-y-auto">
                                <table className="w-full text-sm">
                                    <thead className="bg-gray-100 sticky top-0">
                                        <tr>
                                            <th className="px-3 py-3 text-left cursor-pointer hover:bg-gray-200 select-none" onClick={() => handleSort('productName')}>Ï†úÌíà <SortIcon field="productName" currentField={sortField} direction={sortDir} /></th>
                                            <th className="px-3 py-3 text-left cursor-pointer hover:bg-gray-200 select-none" onClick={() => handleSort('customerName')}>Í≥†Í∞ùÏÇ¨ <SortIcon field="customerName" currentField={sortField} direction={sortDir} /></th>
                                            <th className="px-3 py-3 text-right cursor-pointer hover:bg-gray-200 select-none" onClick={() => handleSort('orderQty')}>Ï£ºÎ¨∏ÏàòÎüâ <SortIcon field="orderQty" currentField={sortField} direction={sortDir} /></th>
                                            <th className="px-3 py-3 text-right cursor-pointer hover:bg-gray-200 select-none" onClick={() => handleSort('possibleQty')}>ÏÉùÏÇ∞Í∞ÄÎä• <SortIcon field="possibleQty" currentField={sortField} direction={sortDir} /></th>
                                            <th className="px-3 py-3 text-center cursor-pointer hover:bg-gray-200 select-none" onClick={() => handleSort('minCoverage')}>Ïª§Î≤ÑÏú® <SortIcon field="minCoverage" currentField={sortField} direction={sortDir} /></th>
                                            <th className="px-3 py-3 text-right cursor-pointer hover:bg-gray-200 select-none" onClick={() => handleSort('shortageQty')}>Î∂ÄÏ°±ÏàòÎüâ <SortIcon field="shortageQty" currentField={sortField} direction={sortDir} /></th>
                                            <th className="px-3 py-3 text-center cursor-pointer hover:bg-gray-200 select-none" onClick={() => handleSort('status')}>ÏÉÅÌÉú <SortIcon field="status" currentField={sortField} direction={sortDir} /></th>
                                            <th className="px-3 py-3 text-left">Î∂ÄÏ°±ÏûêÏû¨</th>
                                        </tr>
                                    </thead>
                                    <tbody className="divide-y">
                                        {filteredAndSorted.map((r, idx) => (
                                            <tr key={idx} className="hover:bg-gray-50">
                                                <td className="px-3 py-3">
                                                    <div className="font-medium text-gray-800">{r.productName}</div>
                                                    <div className="text-xs text-gray-400 font-mono">{r.partNo}</div>
                                                </td>
                                                <td className="px-3 py-3 text-gray-600">{r.customerName}</td>
                                                <td className="px-3 py-3 text-right">{r.orderQty?.toLocaleString()}</td>
                                                <td className="px-3 py-3 text-right font-bold text-green-600">{r.possibleQty?.toLocaleString()}</td>
                                                <td className="px-3 py-3 text-center">
                                                    <span className={`px-2 py-0.5 rounded text-xs font-medium ${r.minCoverage >= 100 ? 'bg-green-100 text-green-800' : r.minCoverage >= 50 ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}`}>
                                                        {(r.minCoverage || 0).toFixed(1)}%
                                                    </span>
                                                </td>
                                                <td className="px-3 py-3 text-right font-medium text-red-600">{r.shortageQty > 0 ? r.shortageQty?.toLocaleString() : '-'}</td>
                                                <td className="px-3 py-3 text-center"><StatusBadge status={r.status} /></td>
                                                <td className="px-3 py-3 text-sm">
                                                    {r.shortageCount > 0 ? (
                                                        <div className="flex flex-wrap gap-1">
                                                            {r.materials?.filter(m => m.status === 'shortage').slice(0, 3).map((m, i) => (
                                                                <span key={i} className="px-2 py-0.5 bg-red-100 text-red-700 rounded text-xs">{m.partNo}</span>
                                                            ))}
                                                            {r.shortageCount > 3 && <span className="text-xs text-gray-500">+{r.shortageCount - 3}Í±¥</span>}
                                                        </div>
                                                    ) : '-'}
                                                </td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // ========== ÌòëÎ†•ÏÇ¨Î≥Ñ Î∂ÄÏ°±ÏàòÎüâ Ï°∞Ìöå Ïª¥Ìè¨ÎÑåÌä∏ ==========
        function SupplierShortageView({ supplierShortage, selectedParts, mrpResults }) {
            const [isExpanded, setIsExpanded] = useState(true);
            const [searchTerm, setSearchTerm] = useState('');
            const [sortField, setSortField] = useState('totalShortage');
            const [sortDir, setSortDir] = useState('desc');
            const [expandedSupplier, setExpandedSupplier] = useState(null);

            // ÏÑ†ÌÉùÎêú Ï†úÌíàÎì§Ïùò Î∂ÄÏ°± ÏûêÏû¨Î•º ÌòëÎ†•ÏÇ¨Î≥ÑÎ°ú Ïû¨ÏßëÍ≥Ñ
            const filteredSupplierShortage = useMemo(() => {
                const result = {};
                selectedParts.forEach(partNo => {
                    const mrp = mrpResults[partNo];
                    if (!mrp || !mrp.materials) return;
                    mrp.materials.forEach(m => {
                        if (m.shortage > 0) {
                            const supplier = m.supplier || '(ÎØ∏ÏßÄÏ†ï)';
                            if (!result[supplier]) result[supplier] = { itemCount: 0, totalShortage: 0, items: [] };
                            // Ï§ëÎ≥µ Ï≤¥ÌÅ¨ (Í∞ôÏùÄ ÏûêÏû¨Í∞Ä Ïó¨Îü¨ Ï†úÌíàÏóêÏÑú Î∂ÄÏ°±Ìï† Ïàò ÏûàÏùå)
                            const existingItem = result[supplier].items.find(i => i.partNo === m.partNo);
                            if (existingItem) {
                                existingItem.shortage += m.shortage;
                                result[supplier].totalShortage += m.shortage;
                            } else {
                                result[supplier].itemCount++;
                                result[supplier].totalShortage += m.shortage;
                                result[supplier].items.push({ partNo: m.partNo, partName: m.partName, shortage: m.shortage });
                            }
                        }
                    });
                });
                return result;
            }, [selectedParts, mrpResults]);

            const suppliers = Object.entries(filteredSupplierShortage)
                .map(([name, data]) => ({ name, ...data }))
                .sort((a, b) => {
                    let aVal = a[sortField], bVal = b[sortField];
                    if (typeof aVal === 'string') { aVal = aVal?.toLowerCase(); bVal = bVal?.toLowerCase(); }
                    if (aVal < bVal) return sortDir === 'asc' ? -1 : 1;
                    if (aVal > bVal) return sortDir === 'asc' ? 1 : -1;
                    return 0;
                });

            const filtered = suppliers.filter(s => s.name?.toLowerCase().includes(searchTerm.toLowerCase()));

            const exportToExcel = () => {
                const data = [];
                filtered.forEach(s => {
                    s.items.forEach(item => {
                        data.push({ 'ÌòëÎ†•ÏÇ¨': s.name, 'ÏûêÏû¨ÏΩîÎìú': item.partNo, 'ÏûêÏû¨Î™Ö': item.partName, 'Î∂ÄÏ°±ÏàòÎüâ': item.shortage });
                    });
                });
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'ÌòëÎ†•ÏÇ¨Î≥ÑÎ∂ÄÏ°±ÌòÑÌô©');
                XLSX.writeFile(wb, 'ÌòëÎ†•ÏÇ¨Î≥Ñ_Î∂ÄÏ°±ÌòÑÌô©.xlsx');
            };

            if (suppliers.length === 0) return null;

            return (
                <div className="bg-white rounded-2xl shadow-lg overflow-hidden">
                    <div className="p-4 bg-gray-50 cursor-pointer flex justify-between items-center" onClick={() => setIsExpanded(!isExpanded)}>
                        <div className="flex items-center gap-2">
                            <span className="text-xl">üìä</span>
                            <h2 className="text-lg font-bold text-gray-800">ÌòëÎ†•ÏÇ¨Î≥Ñ Î∂ÄÏ°±ÏàòÎüâ Ï°∞Ìöå ({suppliers.length}Í∞úÏÇ¨)</h2>
                        </div>
                        <div className="flex items-center gap-2">
                            <button onClick={(e) => { e.stopPropagation(); exportToExcel(); }} className="flex items-center gap-2 px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm">
                                <Icons.Download /> Excel
                            </button>
                            {isExpanded ? <Icons.ChevronUp /> : <Icons.ChevronDown />}
                        </div>
                    </div>

                    {isExpanded && (
                        <div className="p-6">
                            <div className="mb-4 flex gap-2">
                                <div className="relative flex-1 max-w-md">
                                    <input type="text" placeholder="ÌòëÎ†•ÏÇ¨Î™Ö Í≤ÄÏÉâ..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)}
                                        className="w-full pl-9 pr-4 py-2 border border-gray-200 rounded-xl" />
                                    <div className="absolute left-3 top-2.5 text-gray-400"><Icons.Search /></div>
                                </div>
                            </div>

                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                {filtered.map((supplier, idx) => (
                                    <div key={idx} className="border border-gray-200 rounded-xl overflow-hidden hover:shadow-md transition-shadow">
                                        <div
                                            className="p-4 cursor-pointer hover:bg-gray-50"
                                            onClick={() => setExpandedSupplier(expandedSupplier === supplier.name ? null : supplier.name)}
                                        >
                                            <div className="flex items-center justify-between mb-2">
                                                <h3 className="font-bold text-gray-800">{supplier.name}</h3>
                                                <span className="text-gray-400">{expandedSupplier === supplier.name ? '‚ñ≤' : '‚ñº'}</span>
                                            </div>
                                            <div className="flex justify-between text-sm">
                                                <span className="text-gray-500">Î∂ÄÏ°± ÌíàÎ™©</span>
                                                <span className="font-bold text-red-600">{supplier.itemCount}Ï¢Ö</span>
                                            </div>
                                            <div className="flex justify-between text-sm mt-1">
                                                <span className="text-gray-500">Ï¥ù Î∂ÄÏ°±ÏàòÎüâ</span>
                                                <span className="font-bold text-red-600">{supplier.totalShortage?.toLocaleString()}</span>
                                            </div>
                                        </div>
                                        {expandedSupplier === supplier.name && supplier.items && (
                                            <div className="border-t bg-gray-50 p-3 max-h-48 overflow-y-auto">
                                                <table className="w-full text-xs">
                                                    <thead>
                                                        <tr className="text-gray-500">
                                                            <th className="text-left py-1">ÏûêÏû¨ÏΩîÎìú</th>
                                                            <th className="text-right py-1">Î∂ÄÏ°±ÏàòÎüâ</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {supplier.items.map((item, i) => (
                                                            <tr key={i} className="border-t border-gray-200">
                                                                <td className="py-1 font-mono">{item.partNo}</td>
                                                                <td className="py-1 text-right text-red-600 font-medium">-{item.shortage?.toLocaleString()}</td>
                                                            </tr>
                                                        ))}
                                                    </tbody>
                                                </table>
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // ========== Î©îÏù∏ App Ïª¥Ìè¨ÎÑåÌä∏ ==========
        function App() {
            const [loading, setLoading] = useState(true);
            const [authChecked, setAuthChecked] = useState(false);
            const [user, setUser] = useState(null);
            const [rawData, setRawData] = useState({ bom: [], inventory: [], sales: [] });
            const [selectedParts, setSelectedParts] = useState([]);
            const [showAnalysis, setShowAnalysis] = useState(false);
            const [loadError, setLoadError] = useState(null);

            useEffect(() => {
                const checkAuth = async () => {
                    if (localStorage.getItem('mrp_demo_mode') === 'true') {
                        setUser({ name: 'Îç∞Î™® ÏÇ¨Ïö©Ïûê', email: 'demo@example.com', isDemo: true });
                        setAuthChecked(true);
                        return;
                    }
                    let attempts = 0;
                    while (!supabaseClient && attempts < 50) {
                        if (initSupabase()) break;
                        await new Promise(r => setTimeout(r, 100));
                        attempts++;
                    }
                    if (!supabaseClient) {
                        setLoadError('Supabase Ïó∞Í≤∞ Ïã§Ìå®');
                        setLoading(false);
                        return;
                    }
                    try {
                        const { data: { session } } = await supabaseClient.auth.getSession();
                        if (session?.user) {
                            setUser(session.user);
                            setAuthChecked(true);
                        } else {
                            window.location.href = 'login.html';
                        }
                    } catch (e) {
                        window.location.href = 'login.html';
                    }
                };
                checkAuth();
            }, []);

            useEffect(() => {
                if (!authChecked) return;
                const loadData = async () => {
                    try {
                        const loaded = {};
                        for (const type of ['bom', 'inventory', 'sales']) {
                            const { data, error } = await supabaseClient
                                .from('mrp_data').select('*').eq('data_type', type)
                                .order('updated_at', { ascending: false }).limit(1);
                            if (error) throw error;
                            loaded[type] = data?.[0]?.data?.data || [];
                        }
                        setRawData(loaded);
                        setLoading(false);
                    } catch (e) {
                        setLoadError(e.message);
                        setLoading(false);
                    }
                };
                loadData();
            }, [authChecked]);

            const { salesPlan, bomRelations, inventory, mrpResults, summary, supplierShortage } = useMemo(() => {
                if (!rawData.bom.length) return { salesPlan: [], bomRelations: {}, inventory: {}, mrpResults: {}, summary: {}, supplierShortage: {} };

                const salesPlan = rawData.sales.map(row => ({
                    partNo: row['ÌíàÎ≤à'] || row['Î™®ÌíàÎ≤à'] || row['customerPartNo'] || Object.values(row)[0],
                    customerPN: row['Í≥†Í∞ùÏÇ¨P/N'] || row['customerPN'] || '',
                    productName: row['ÌíàÎ™Ö'] || row['Ï†úÌíàÎ™Ö'] || row['productName'] || '',
                    customerName: row['Í≥†Í∞ùÏÇ¨'] || row['customerName'] || '',
                    orderQty: parseFloat(row['Îß§Ï∂úÏàòÎüâ'] || row['Í≥ÑÌöçÏàòÎüâ'] || row['orderQty'] || 0) || 0
                }));

                const bomRelations = {};
                rawData.bom.forEach(row => {
                    const parent = row['Î™®ÌíàÎ≤à'] || row['parentPartNo'] || Object.values(row)[0];
                    const child = row['ÏûêÌíàÎ≤à'] || row['childPartNo'] || row['partNo'] || Object.values(row)[1];
                    const level = parseInt(row['Î†àÎ≤®'] || row['level'] || Object.values(row)[2]) || 1;
                    const qty = parseFloat(row['ÏÜåÏöîÎüâ'] || row['usage'] || row['qty'] || Object.values(row)[3]) || 1;
                    if (!bomRelations[parent]) bomRelations[parent] = [];
                    bomRelations[parent].push({
                        childPn: child,
                        childName: row['ÏûêÏû¨Î™Ö'] || row['partName'] || row['childName'] || child,
                        level, qty,
                        supplier: row['ÌòëÎ†•ÏÇ¨'] || row['supplier'] || '(ÎØ∏ÏßÄÏ†ï)'
                    });
                });

                const inventory = {};
                rawData.inventory.forEach(row => {
                    const pn = row['ÌíàÎ≤à'] || row['partNo'] || Object.values(row)[0];
                    inventory[pn] = parseFloat(row['Ïû¨Í≥†ÏàòÎüâ'] || row['stockQty'] || row['qty'] || Object.values(row)[1]) || 0;
                });

                const mrpResults = {};
                const supplierShortage = {};

                salesPlan.forEach(sale => {
                    const children = (bomRelations[sale.partNo] || []).filter(c => c.level === 1);
                    const materials = [];
                    let minCoverage = children.length > 0 ? Infinity : 100;

                    children.forEach(child => {
                        const requiredQty = sale.orderQty * child.qty;
                        const stockQty = inventory[child.childPn] || 0;
                        const coverage = requiredQty > 0 ? (stockQty / requiredQty) * 100 : 100;
                        const shortage = Math.max(0, requiredQty - stockQty);

                        materials.push({
                            partNo: child.childPn, partName: child.childName, supplier: child.supplier,
                            usage: child.qty, requiredQty, stockQty,
                            coverage: Math.round(coverage * 10) / 10, shortage,
                            status: shortage > 0 ? 'shortage' : 'ok'
                        });

                        minCoverage = Math.min(minCoverage, coverage);

                        if (shortage > 0) {
                            const supplier = child.supplier || '(ÎØ∏ÏßÄÏ†ï)';
                            if (!supplierShortage[supplier]) supplierShortage[supplier] = { itemCount: 0, totalShortage: 0, items: [] };
                            supplierShortage[supplier].itemCount++;
                            supplierShortage[supplier].totalShortage += shortage;
                            supplierShortage[supplier].items.push({ partNo: child.childPn, shortage });
                        }
                    });

                    minCoverage = minCoverage === Infinity ? 100 : Math.round(minCoverage * 10) / 10;
                    const possibleQty = Math.floor(sale.orderQty * minCoverage / 100);
                    const shortageCount = materials.filter(m => m.status === 'shortage').length;
                    const status = minCoverage >= 100 ? 'full' : minCoverage > 0 ? 'partial' : 'none';

                    mrpResults[sale.partNo] = { ...sale, possibleQty, shortageQty: sale.orderQty - possibleQty, minCoverage, shortageCount, status, materials };
                });

                const summary = {
                    total: salesPlan.length,
                    full: Object.values(mrpResults).filter(r => r.status === 'full').length,
                    partial: Object.values(mrpResults).filter(r => r.status === 'partial').length,
                    none: Object.values(mrpResults).filter(r => r.status === 'none').length
                };

                return { salesPlan, bomRelations, inventory, mrpResults, summary, supplierShortage };
            }, [rawData]);

            if (loading) {
                return (
                    <div className="min-h-screen flex items-center justify-center gradient-header">
                        <div className="text-center">
                            <div className="inline-flex items-center justify-center w-16 h-16 bg-white rounded-2xl shadow-lg mb-4"><span className="text-3xl">üì¶</span></div>
                            <h1 className="text-2xl font-bold text-white mb-4">MRP ÏãúÏä§ÌÖú</h1>
                            <div className="w-12 h-12 border-4 border-white border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
                            <p className="text-white/80">{authChecked ? 'Îç∞Ïù¥ÌÑ∞ Î°úÎî© Ï§ë...' : 'Ïù∏Ï¶ù ÌôïÏù∏ Ï§ë...'}</p>
                        </div>
                    </div>
                );
            }

            if (loadError) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-gray-100">
                        <div className="text-center bg-white p-8 rounded-2xl shadow-lg max-w-md">
                            <div className="text-5xl mb-4">‚ö†Ô∏è</div>
                            <h2 className="text-xl font-bold text-gray-800 mb-2">Îç∞Ïù¥ÌÑ∞ Î°úÎìú Ïã§Ìå®</h2>
                            <p className="text-gray-600 mb-4">{loadError}</p>
                            <button onClick={() => window.location.reload()} className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Îã§Ïãú ÏãúÎèÑ</button>
                        </div>
                    </div>
                );
            }

            if (!salesPlan.length) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-gray-100">
                        <div className="text-center bg-white p-8 rounded-2xl shadow-lg">
                            <p className="text-gray-600 mb-4">Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§. ÌååÏùºÏùÑ Î®ºÏ†Ä ÏóÖÎ°úÎìúÌïòÏÑ∏Ïöî.</p>
                            <a href="upload.html" className="px-6 py-3 bg-blue-600 text-white rounded-xl hover:bg-blue-700">ÌååÏùº ÏóÖÎ°úÎìúÌïòÍ∏∞ ‚Üí</a>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-100">
                    <header className="gradient-header text-white p-6">
                        <div className="max-w-7xl mx-auto">
                            <div className="flex items-center justify-between mb-4">
                                <div>
                                    <h1 className="text-2xl font-bold">MRP ÏÉùÏÇ∞Í≥ÑÌöç Î∂ÑÏÑù ÏãúÏä§ÌÖú <span className="text-sm bg-white/20 px-2 py-1 rounded">v6</span></h1>
                                    <p className="text-blue-200">ÌòÑÏû¨Í≥† Í∏∞Î∞ò ÏÉùÏÇ∞ Í∞ÄÎä• ÏàòÎüâ Î∂ÑÏÑù Î∞è Î∂ÄÏ°± ÏûêÏû¨ Ï°∞Ìöå</p>
                                </div>
                                <div className="flex gap-2">
                                    <a href="upload.html" className="px-4 py-2 bg-white/20 rounded-lg hover:bg-white/30">ÌååÏùº ÏóÖÎ°úÎìú</a>
                                    <button onClick={() => { localStorage.clear(); window.location.href = 'login.html'; }} className="px-4 py-2 bg-red-500/80 rounded-lg hover:bg-red-600">Î°úÍ∑∏ÏïÑÏõÉ</button>
                                </div>
                            </div>
                            <div className="flex gap-3 flex-wrap">
                                <span className="px-4 py-2 bg-blue-700 rounded-lg">ÏòÅÏóÖÍ≥ÑÌöç <strong>{summary.total}Í±¥</strong></span>
                                <span className="px-4 py-2 bg-green-600 rounded-lg">ÏÉùÏÇ∞Í∞ÄÎä• <strong>{summary.full}Í±¥</strong></span>
                                <span className="px-4 py-2 bg-yellow-500 text-yellow-900 rounded-lg">ÏùºÎ∂ÄÍ∞ÄÎä• <strong>{summary.partial}Í±¥</strong></span>
                                <span className="px-4 py-2 bg-red-600 rounded-lg">ÏÉùÏÇ∞Î∂àÍ∞Ä <strong>{summary.none}Í±¥</strong></span>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto p-6">
                        <UrgentOrderCheck salesPlan={salesPlan} bomRelations={bomRelations} inventory={inventory} />
                        <SalesPlanSelection
                            salesPlan={salesPlan}
                            selectedParts={selectedParts}
                            onSelectionChange={(parts) => { setSelectedParts(parts); setShowAnalysis(false); }}
                            mrpResults={mrpResults}
                            onAnalyze={() => setShowAnalysis(true)}
                        />
                        {showAnalysis && selectedParts.length > 0 && (
                            <>
                                <AnalysisResults selectedParts={selectedParts} mrpResults={mrpResults} salesPlan={salesPlan} />
                                <SupplierShortageView supplierShortage={supplierShortage} selectedParts={selectedParts} mrpResults={mrpResults} />
                            </>
                        )}
                    </main>

                    <footer className="text-center py-4 text-gray-400 text-sm">MRP ÏÉùÏÇ∞Í≥ÑÌöç Î∂ÑÏÑù ÏãúÏä§ÌÖú v6 + Supabase</footer>
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
