<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MRP ì‹œìŠ¤í…œ - íŒŒì¼ ì—…ë¡œë“œ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <style>
        .apple-header { background: white; border-bottom: 1px solid #E8E8ED; }
        .upload-zone { border: 2px dashed #d1d5db; transition: all 0.2s; }
        .upload-zone:hover { border-color: #007AFF; background-color: #F5F5F7; }
        .upload-zone.dragover { border-color: #007AFF; background-color: #F5F5F7; }
        /* ì°½ê³  í•„í„° ìŠ¤íƒ€ì¼ */
        .warehouse-filter { margin-top: 16px; }
        .warehouse-dropdown { position: relative; }
        .warehouse-btn { width: 100%; padding: 10px 12px; border: 2px solid #E5E7EB; border-radius: 8px; background: white; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s; }
        .warehouse-btn:hover { border-color: #007AFF; }
        .warehouse-btn.active { border-color: #007AFF; box-shadow: 0 0 0 3px rgba(0,122,255,0.1); }
        .warehouse-menu { position: absolute; top: 100%; left: 0; right: 0; margin-top: 4px; background: white; border: 1px solid #E5E7EB; border-radius: 8px; box-shadow: 0 10px 25px rgba(0,0,0,0.15); max-height: 280px; overflow-y: auto; z-index: 50; display: none; }
        .warehouse-menu.show { display: block; animation: slideDown 0.2s ease; }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-8px); } to { opacity: 1; transform: translateY(0); } }
        .warehouse-item { display: flex; align-items: center; padding: 10px 12px; cursor: pointer; transition: background 0.15s; }
        .warehouse-item:hover { background: #F3F4F6; }
        .warehouse-item.selected { background: #EFF6FF; }
        .warehouse-checkbox { width: 18px; height: 18px; border: 2px solid #D1D5DB; border-radius: 4px; margin-right: 10px; display: flex; align-items: center; justify-content: center; transition: all 0.15s; flex-shrink: 0; }
        .warehouse-item.selected .warehouse-checkbox { background: #007AFF; border-color: #007AFF; }
        .warehouse-checkbox svg { width: 12px; height: 12px; color: white; opacity: 0; }
        .warehouse-item.selected .warehouse-checkbox svg { opacity: 1; }
        .warehouse-count { margin-left: auto; font-size: 12px; color: #9CA3AF; background: #F3F4F6; padding: 2px 8px; border-radius: 10px; }
        .warehouse-actions { display: flex; gap: 8px; padding: 8px 12px; border-top: 1px solid #E5E7EB; background: #F9FAFB; }
        .warehouse-actions button { flex: 1; padding: 6px 12px; border-radius: 6px; font-size: 13px; cursor: pointer; transition: all 0.15s; }
        .btn-select-all { background: #EFF6FF; color: #007AFF; border: 1px solid #BFDBFE; }
        .btn-select-all:hover { background: #DBEAFE; }
        .btn-clear { background: white; color: #6B7280; border: 1px solid #E5E7EB; }
        .btn-clear:hover { background: #F3F4F6; }
        .selected-tags { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 10px; }
        .selected-tag { display: inline-flex; align-items: center; gap: 4px; padding: 4px 10px; background: #EFF6FF; color: #007AFF; border-radius: 20px; font-size: 12px; }
        .selected-tag button { background: none; border: none; color: #007AFF; cursor: pointer; font-size: 14px; line-height: 1; padding: 0; margin-left: 2px; }
        .selected-tag button:hover { color: #0056CC; }
    </style>
</head>
<body class="min-h-screen bg-gray-50">
    <header class="apple-header p-4">
        <div class="max-w-6xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3">
                <span class="text-2xl">ğŸ“¦</span>
                <div>
                    <h1 class="text-xl font-bold text-gray-900">MRP ì‹œìŠ¤í…œ</h1>
                    <p class="text-sm text-gray-500">íŒŒì¼ ì—…ë¡œë“œ</p>
                </div>
            </div>
            <div class="flex gap-2">
                <a href="mrp.html" class="px-4 py-2 bg-[#007AFF] text-white rounded-lg hover:bg-[#0056CC]">MRP ë¶„ì„</a>
                <button onclick="handleLogout()" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>
    </header>

    <main class="max-w-6xl mx-auto p-6">
        <div id="loading" class="hidden text-center py-4">
            <div class="inline-flex items-center gap-2 text-[#007AFF]">
                <svg class="animate-spin w-5 h-5" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span>ë°ì´í„° ì²˜ë¦¬ ì¤‘...</span>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <div class="bg-white rounded-xl shadow p-6">
                <div class="flex items-center gap-2 mb-4">
                    <span class="text-2xl">ğŸ“‹</span>
                    <h3 class="font-bold">BOM (ìì¬ëª…ì„¸ì„œ)</h3>
                </div>
                <div id="bom-zone" class="upload-zone rounded-lg p-8 text-center cursor-pointer"
                     onclick="document.getElementById('bom-input').click()"
                     ondrop="handleDrop(event,'bom')" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                    <p class="text-gray-500">í´ë¦­í•˜ê±°ë‚˜ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì„¸ìš”</p>
                    <p class="text-xs text-gray-400 mt-2">í•„ìˆ˜: ëª¨í’ˆë²ˆ, ìí’ˆë²ˆ, ë ˆë²¨</p>
                </div>
                <input type="file" id="bom-input" class="hidden" accept=".xlsx,.xls,.csv" onchange="handleFileSelect(event,'bom')">
                <div id="bom-info" class="mt-4 hidden"></div>
            </div>

            <div class="bg-white rounded-xl shadow p-6">
                <div class="flex items-center gap-2 mb-4">
                    <span class="text-2xl">ğŸ“¦</span>
                    <h3 class="font-bold">ì¬ê³  í˜„í™©</h3>
                </div>
                <div id="inventory-zone" class="upload-zone rounded-lg p-8 text-center cursor-pointer"
                     onclick="document.getElementById('inv-input').click()"
                     ondrop="handleDrop(event,'inventory')" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                    <p class="text-gray-500">í´ë¦­í•˜ê±°ë‚˜ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì„¸ìš”</p>
                    <p class="text-xs text-gray-400 mt-2">í•„ìˆ˜: í’ˆë²ˆ, ì¬ê³ ìˆ˜ëŸ‰</p>
                </div>
                <input type="file" id="inv-input" class="hidden" accept=".xlsx,.xls,.csv" onchange="handleFileSelect(event,'inventory')">
                <div id="inventory-info" class="mt-4 hidden"></div>

                <!-- ì°½ê³  ì„ íƒ í•„í„° (ì¬ê³  ì—…ë¡œë“œ í›„ í‘œì‹œ) -->
                <div id="warehouse-filter" class="warehouse-filter hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        ğŸ­ ì°½ê³  ì„ íƒ <span class="text-xs text-gray-400">(ë³µìˆ˜ ì„ íƒ ê°€ëŠ¥)</span>
                    </label>
                    <div class="warehouse-dropdown">
                        <button type="button" class="warehouse-btn" onclick="toggleWarehouseMenu(event)">
                            <span id="warehouse-btn-text">ì°½ê³ ë¥¼ ì„ íƒí•˜ì„¸ìš”</span>
                            <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                            </svg>
                        </button>
                        <div id="warehouse-menu" class="warehouse-menu">
                            <div id="warehouse-list"></div>
                            <div class="warehouse-actions">
                                <button type="button" class="btn-select-all" onclick="selectAllWarehouses()">ì „ì²´ ì„ íƒ</button>
                                <button type="button" class="btn-clear" onclick="clearWarehouseSelection()">ì„ íƒ í•´ì œ</button>
                            </div>
                        </div>
                    </div>
                    <div id="selected-warehouses" class="selected-tags"></div>
                    <div id="warehouse-summary" class="mt-3 p-3 bg-blue-50 rounded-lg hidden">
                        <p class="text-blue-700 text-sm" id="warehouse-summary-text"></p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-xl shadow p-6">
                <div class="flex items-center gap-2 mb-4">
                    <span class="text-2xl">ğŸ“Š</span>
                    <h3 class="font-bold">ì˜ì—…ê³„íš</h3>
                </div>
                <div id="sales-zone" class="upload-zone rounded-lg p-8 text-center cursor-pointer"
                     onclick="document.getElementById('sales-input').click()"
                     ondrop="handleDrop(event,'sales')" ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)">
                    <p class="text-gray-500">í´ë¦­í•˜ê±°ë‚˜ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì„¸ìš”</p>
                    <p class="text-xs text-gray-400 mt-2">í•„ìˆ˜: í’ˆë²ˆ, í•©ê³„/ë§¤ì¶œìˆ˜ëŸ‰/ê³„íšìˆ˜ëŸ‰</p>
                </div>
                <input type="file" id="sales-input" class="hidden" accept=".xlsx,.xls,.csv" onchange="handleFileSelect(event,'sales')">
                <div id="sales-info" class="mt-4 hidden"></div>
            </div>
        </div>

        <div class="text-center">
            <button onclick="goToMRP()" class="px-8 py-3 bg-[#007AFF] text-white rounded-lg font-medium hover:bg-[#0056CC] shadow-sm">
                MRP ë¶„ì„ ì‹œì‘ â†’
            </button>
        </div>
    </main>

    <script>
        // Supabase ì„¤ì •
        const SUPABASE_URL = 'https://vnhjfbcufmbbhwevzunc.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZuaGpmYmN1Zm1iYmh3ZXZ6dW5jIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5MzE2NDEsImV4cCI6MjA4NTUwNzY0MX0.ZZFMYH172ByFDOpBNH_4ehsDNoKMqmLIvdhiCv_27Zo';

        let supabaseClient = null;
        const uploadedData = { bom: null, inventory: null, sales: null };

        // ì°½ê³  í•„í„° ê´€ë ¨ ë³€ìˆ˜
        let allWarehouses = [];           // ê°ì§€ëœ ëª¨ë“  ì°½ê³  ëª©ë¡
        let selectedWarehouses = [];      // ì„ íƒëœ ì°½ê³  ëª©ë¡
        let warehouseCounts = {};         // ì°½ê³ ë³„ í’ˆëª© ìˆ˜
        let rawInventoryData = [];        // ì›ë³¸ ì¬ê³  ë°ì´í„° (í•„í„°ë§ ì „)

        // Supabase ì´ˆê¸°í™”
        function initSupabase() {
            if (window.supabase && typeof window.supabase.createClient === 'function') {
                supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log('Supabase ì´ˆê¸°í™” ì™„ë£Œ');
                return true;
            }
            return false;
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ Supabase ì´ˆê¸°í™” ë° ì¸ì¦/ê¶Œí•œ ì²´í¬
        async function initAndCheckAuth() {
            // SDK ë¡œë”© ëŒ€ê¸°
            let attempts = 0;
            while (!initSupabase() && attempts < 50) {
                await new Promise(r => setTimeout(r, 100));
                attempts++;
            }

            // ì—­í•  ì²´í¬ í•¨ìˆ˜
            function checkUploadPermission() {
                const userRole = JSON.parse(localStorage.getItem('mrp_user_role') || '{}');
                if (userRole.role === 'viewer') {
                    alert('íŒŒì¼ ì—…ë¡œë“œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. (ë·°ì–´ëŠ” ì¡°íšŒë§Œ ê°€ëŠ¥)');
                    window.location.href = 'mrp.html';
                    return false;
                }
                return true;
            }

            // ë°ëª¨ ëª¨ë“œ ì²´í¬
            if (localStorage.getItem('mrp_demo_mode') === 'true') {
                // ë°ëª¨ ëª¨ë“œëŠ” viewerë¡œ ì„¤ì •ë˜ì–´ ìˆìŒ
                const userRole = JSON.parse(localStorage.getItem('mrp_user_role') || '{}');
                if (userRole.role === 'viewer') {
                    alert('ë°ëª¨ ëª¨ë“œì—ì„œëŠ” íŒŒì¼ ì—…ë¡œë“œê°€ ë¶ˆê°€ëŠ¥í•©ë‹ˆë‹¤.');
                    window.location.href = 'mrp.html';
                    return;
                }
                loadSavedData();
                return;
            }

            // Supabase ì„¸ì…˜ ì²´í¬
            if (supabaseClient) {
                try {
                    const { data: { session } } = await supabaseClient.auth.getSession();
                    if (session?.user) {
                        if (!checkUploadPermission()) return;
                        loadSavedData(); // ê¶Œí•œ í™•ì¸ í›„ ë°ì´í„° ë¡œë“œ
                        return;
                    }
                } catch (e) {
                    console.error('ì„¸ì…˜ ì²´í¬ ì˜¤ë¥˜:', e);
                }
            }

            // ì¸ì¦ ì•ˆë¨ â†’ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ
            window.location.href = 'login.html';
        }

        initAndCheckAuth();

        // ì €ì¥ëœ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadSavedData() {
            if (!supabaseClient) return;

            showLoading(true);
            try {
                for (const type of ['bom', 'inventory', 'sales']) {
                    const { data, error } = await supabaseClient
                        .from('mrp_data')
                        .select('*')
                        .eq('data_type', type)
                        .order('updated_at', { ascending: false })
                        .limit(1);

                    if (!error && data && data.length > 0) {
                        uploadedData[type] = data[0].data;
                        showFileInfo(type, data[0].data.name || type, data[0].data.rows || data[0].data.data?.length || 0);

                        // ì¬ê³  ë°ì´í„°ì—ì„œ ì°½ê³  ì •ë³´ ë³µì›
                        if (type === 'inventory' && data[0].data.allWarehouses) {
                            rawInventoryData = data[0].data.data || [];
                            allWarehouses = data[0].data.allWarehouses || [];
                            selectedWarehouses = data[0].data.selectedWarehouses || [...allWarehouses];

                            // ì°½ê³ ë³„ í’ˆëª© ìˆ˜ ê³„ì‚°
                            warehouseCounts = {};
                            rawInventoryData.forEach(row => {
                                const wh = row['ì°½ê³ ëª…'] || row['ì°½ê³ '] || row['warehouse'];
                                if (wh && wh !== 'í•©ê³„') {
                                    warehouseCounts[wh] = (warehouseCounts[wh] || 0) + 1;
                                }
                            });

                            if (allWarehouses.length > 0) {
                                document.getElementById('warehouse-filter').classList.remove('hidden');
                                updateWarehouseUI();
                                // ìš”ì•½ í‘œì‹œ
                                const filteredCount = rawInventoryData.filter(row => {
                                    const wh = row['ì°½ê³ ëª…'] || row['ì°½ê³ '] || row['warehouse'] || '';
                                    return selectedWarehouses.includes(wh);
                                }).length;
                                const summaryEl = document.getElementById('warehouse-summary');
                                const summaryText = document.getElementById('warehouse-summary-text');
                                summaryText.innerHTML = `âœ“ <strong>${selectedWarehouses.length}ê°œ ì°½ê³ </strong> ì„ íƒ Â· ${filteredCount.toLocaleString()}ê°œ í’ˆëª©`;
                                summaryEl.classList.remove('hidden');
                            }
                        }
                    }
                }
            } catch (e) {
                console.error('ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', e);
            }
            showLoading(false);
        }

        function showLoading(show) {
            document.getElementById('loading').classList.toggle('hidden', !show);
        }

        function handleLogout() {
            localStorage.clear();
            window.location.href = 'login.html';
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('dragover');
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('dragover');
        }

        function handleDrop(e, type) {
            e.preventDefault();
            e.currentTarget.classList.remove('dragover');
            const file = e.dataTransfer?.files[0];
            if (file) processFile(file, type);
        }

        function handleFileSelect(e, type) {
            const file = e.target.files[0];
            if (file) processFile(file, type);
        }

        async function processFile(file, type) {
            if (!file.name.match(/\.(xlsx|xls|csv)$/i)) {
                alert('Excel/CSV íŒŒì¼ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                return;
            }

            showLoading(true);
            const reader = new FileReader();

            reader.onload = async function(ev) {
                try {
                    const wb = XLSX.read(ev.target.result, { type: 'array' });
                    const data = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);

                    // ì¬ê³  íŒŒì¼ì¸ ê²½ìš° ì°½ê³  ê°ì§€
                    if (type === 'inventory') {
                        rawInventoryData = data; // ì›ë³¸ ë°ì´í„° ì €ì¥
                        detectWarehouses(data);  // ì°½ê³  ê°ì§€

                        // ì°½ê³ ê°€ ê°ì§€ë˜ë©´ ì „ì²´ ì„ íƒ ìƒíƒœë¡œ ì €ì¥
                        if (allWarehouses.length > 0) {
                            const saveData = {
                                name: file.name,
                                rows: data.length,
                                data: data,
                                selectedWarehouses: allWarehouses,
                                allWarehouses: allWarehouses
                            };

                            if (supabaseClient) {
                                await supabaseClient
                                    .from('mrp_data')
                                    .delete()
                                    .eq('data_type', type);

                                const { error } = await supabaseClient
                                    .from('mrp_data')
                                    .insert({
                                        data_type: type,
                                        data: saveData
                                    });

                                if (error) {
                                    console.error('Supabase ì €ì¥ ì˜¤ë¥˜:', error);
                                    alert('ë°ì´í„° ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                                } else {
                                    uploadedData[type] = saveData;
                                    showFileInfo(type, file.name, data.length);
                                }
                            }
                            showLoading(false);
                            return;
                        }
                    }

                    const saveData = {
                        name: file.name,
                        rows: data.length,
                        data: data
                    };

                    // Supabaseì— ì €ì¥
                    if (supabaseClient) {
                        // ê¸°ì¡´ ë°ì´í„° ì‚­ì œ í›„ ìƒˆë¡œ ì €ì¥
                        await supabaseClient
                            .from('mrp_data')
                            .delete()
                            .eq('data_type', type);

                        const { error } = await supabaseClient
                            .from('mrp_data')
                            .insert({
                                data_type: type,
                                data: saveData
                            });

                        if (error) {
                            console.error('Supabase ì €ì¥ ì˜¤ë¥˜:', error);
                            alert('ë°ì´í„° ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
                        } else {
                            uploadedData[type] = saveData;
                            showFileInfo(type, file.name, data.length);
                        }
                    } else {
                        alert('Supabase ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                    }
                } catch (err) {
                    alert('íŒŒì¼ ì²˜ë¦¬ ì˜¤ë¥˜: ' + err.message);
                }
                showLoading(false);
            };

            reader.readAsArrayBuffer(file);
        }

        function showFileInfo(type, name, rows) {
            const el = document.getElementById(type + '-info');
            el.innerHTML = `
                <div class="flex items-center justify-between p-3 bg-green-50 rounded-lg">
                    <span class="text-green-700">âœ“ ${name} (${rows}í–‰)</span>
                    <button onclick="deleteFile('${type}')" class="text-red-500 hover:text-red-700">ì‚­ì œ</button>
                </div>
            `;
            el.classList.remove('hidden');
        }

        async function deleteFile(type) {
            showLoading(true);
            if (supabaseClient) {
                await supabaseClient
                    .from('mrp_data')
                    .delete()
                    .eq('data_type', type);
            }
            uploadedData[type] = null;
            document.getElementById(type + '-info').innerHTML = '';
            document.getElementById(type + '-info').classList.add('hidden');

            // ì¬ê³  ì‚­ì œ ì‹œ ì°½ê³  í•„í„° ë¦¬ì…‹
            if (type === 'inventory') {
                allWarehouses = [];
                selectedWarehouses = [];
                warehouseCounts = {};
                rawInventoryData = [];
                document.getElementById('warehouse-filter').classList.add('hidden');
                document.getElementById('warehouse-summary').classList.add('hidden');
                document.getElementById('selected-warehouses').innerHTML = '';
            }

            showLoading(false);
        }

        // ===== ì°½ê³  í•„í„° í•¨ìˆ˜ë“¤ =====

        // ì°½ê³  ë©”ë‰´ í† ê¸€
        function toggleWarehouseMenu(e) {
            e.stopPropagation();
            const menu = document.getElementById('warehouse-menu');
            const btn = e.currentTarget;
            menu.classList.toggle('show');
            btn.classList.toggle('active');
        }

        // ì™¸ë¶€ í´ë¦­ ì‹œ ë©”ë‰´ ë‹«ê¸°
        document.addEventListener('click', function(e) {
            const dropdown = document.querySelector('.warehouse-dropdown');
            const menu = document.getElementById('warehouse-menu');
            const btn = document.querySelector('.warehouse-btn');
            if (dropdown && !dropdown.contains(e.target)) {
                menu?.classList.remove('show');
                btn?.classList.remove('active');
            }
        });

        // ì°½ê³  ëª©ë¡ ë Œë”ë§
        function renderWarehouseList() {
            const listEl = document.getElementById('warehouse-list');
            if (!listEl) return;

            listEl.innerHTML = allWarehouses.map(wh => {
                const isSelected = selectedWarehouses.includes(wh);
                const count = warehouseCounts[wh] || 0;
                return `
                    <div class="warehouse-item ${isSelected ? 'selected' : ''}" onclick="toggleWarehouse('${wh}')">
                        <div class="warehouse-checkbox">
                            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/>
                            </svg>
                        </div>
                        <span>${wh}</span>
                        <span class="warehouse-count">${count.toLocaleString()}ê°œ</span>
                    </div>
                `;
            }).join('');
        }

        // ì°½ê³  ì„ íƒ/í•´ì œ
        function toggleWarehouse(wh) {
            const idx = selectedWarehouses.indexOf(wh);
            if (idx > -1) {
                selectedWarehouses.splice(idx, 1);
            } else {
                selectedWarehouses.push(wh);
            }
            updateWarehouseUI();
            applyWarehouseFilter();
        }

        // ì „ì²´ ì„ íƒ
        function selectAllWarehouses() {
            selectedWarehouses = [...allWarehouses];
            updateWarehouseUI();
            applyWarehouseFilter();
        }

        // ì„ íƒ í•´ì œ
        function clearWarehouseSelection() {
            selectedWarehouses = [];
            updateWarehouseUI();
            applyWarehouseFilter();
        }

        // íŠ¹ì • ì°½ê³  ì œê±° (íƒœê·¸ X ë²„íŠ¼)
        function removeWarehouse(wh) {
            const idx = selectedWarehouses.indexOf(wh);
            if (idx > -1) {
                selectedWarehouses.splice(idx, 1);
                updateWarehouseUI();
                applyWarehouseFilter();
            }
        }

        // UI ì—…ë°ì´íŠ¸
        function updateWarehouseUI() {
            renderWarehouseList();

            // ë²„íŠ¼ í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
            const btnText = document.getElementById('warehouse-btn-text');
            if (selectedWarehouses.length === 0) {
                btnText.textContent = 'ì°½ê³ ë¥¼ ì„ íƒí•˜ì„¸ìš”';
            } else if (selectedWarehouses.length === allWarehouses.length) {
                btnText.textContent = `ì „ì²´ ì°½ê³  (${allWarehouses.length}ê°œ)`;
            } else {
                btnText.textContent = `${selectedWarehouses.length}ê°œ ì°½ê³  ì„ íƒë¨`;
            }

            // ì„ íƒëœ ì°½ê³  íƒœê·¸ í‘œì‹œ
            const tagsEl = document.getElementById('selected-warehouses');
            if (selectedWarehouses.length > 0 && selectedWarehouses.length <= 5) {
                tagsEl.innerHTML = selectedWarehouses.map(wh => `
                    <span class="selected-tag">
                        ${wh}
                        <button onclick="removeWarehouse('${wh}')">&times;</button>
                    </span>
                `).join('');
            } else if (selectedWarehouses.length > 5) {
                tagsEl.innerHTML = `
                    <span class="selected-tag">${selectedWarehouses.length}ê°œ ì°½ê³  ì„ íƒë¨</span>
                `;
            } else {
                tagsEl.innerHTML = '';
            }
        }

        // ì°½ê³  í•„í„° ì ìš© ë° ë°ì´í„° ì €ì¥
        async function applyWarehouseFilter() {
            if (selectedWarehouses.length === 0) {
                document.getElementById('warehouse-summary').classList.add('hidden');
                return;
            }

            showLoading(true);

            // ì„ íƒëœ ì°½ê³ ì˜ ì¬ê³ ë§Œ í•„í„°ë§
            const filteredData = rawInventoryData.filter(row => {
                const wh = row['ì°½ê³ ëª…'] || row['ì°½ê³ '] || row['warehouse'] || '';
                return selectedWarehouses.includes(wh);
            });

            const totalCount = filteredData.length;
            const totalStock = filteredData.reduce((sum, row) => {
                let qty = row['ì¬ê³ '] || row['ì¬ê³ ìˆ˜ëŸ‰'] || row['stockQty'] || 0;
                if (typeof qty === 'string') qty = parseFloat(qty.replace(/,/g, '')) || 0;
                return sum + qty;
            }, 0);

            // ìš”ì•½ í‘œì‹œ
            const summaryEl = document.getElementById('warehouse-summary');
            const summaryText = document.getElementById('warehouse-summary-text');
            summaryText.innerHTML = `âœ“ <strong>${selectedWarehouses.length}ê°œ ì°½ê³ </strong> ì„ íƒ Â· ${totalCount.toLocaleString()}ê°œ í’ˆëª© Â· ì´ ì¬ê³  ${totalStock.toLocaleString()}ê°œ`;
            summaryEl.classList.remove('hidden');

            // í•„í„°ë§ëœ ë°ì´í„°ë¥¼ Supabaseì— ì €ì¥
            const saveData = {
                name: uploadedData.inventory?.name || 'ì¬ê³ í˜„í™©',
                rows: filteredData.length,
                data: filteredData,
                selectedWarehouses: selectedWarehouses,
                allWarehouses: allWarehouses
            };

            if (supabaseClient) {
                await supabaseClient
                    .from('mrp_data')
                    .delete()
                    .eq('data_type', 'inventory');

                const { error } = await supabaseClient
                    .from('mrp_data')
                    .insert({
                        data_type: 'inventory',
                        data: saveData
                    });

                if (error) {
                    console.error('í•„í„°ë§ ë°ì´í„° ì €ì¥ ì˜¤ë¥˜:', error);
                } else {
                    uploadedData.inventory = saveData;
                    // íŒŒì¼ ì •ë³´ ì—…ë°ì´íŠ¸
                    showFileInfo('inventory', saveData.name, filteredData.length);
                }
            }

            showLoading(false);
        }

        // ì¬ê³  íŒŒì¼ì—ì„œ ì°½ê³  ê°ì§€
        function detectWarehouses(data) {
            const warehouses = new Set();
            const counts = {};

            data.forEach(row => {
                const wh = row['ì°½ê³ ëª…'] || row['ì°½ê³ '] || row['warehouse'];
                if (wh && wh !== 'í•©ê³„' && wh.trim() !== '') {
                    warehouses.add(wh);
                    counts[wh] = (counts[wh] || 0) + 1;
                }
            });

            allWarehouses = Array.from(warehouses).sort();
            warehouseCounts = counts;

            // ì°½ê³ ê°€ ê°ì§€ë˜ë©´ í•„í„° UI í‘œì‹œ
            if (allWarehouses.length > 0) {
                document.getElementById('warehouse-filter').classList.remove('hidden');
                // ê¸°ë³¸ê°’: ì „ì²´ ì„ íƒ
                selectedWarehouses = [...allWarehouses];
                updateWarehouseUI();
            } else {
                document.getElementById('warehouse-filter').classList.add('hidden');
            }
        }

        function goToMRP() {
            if (!uploadedData.bom || !uploadedData.inventory || !uploadedData.sales) {
                alert('ëª¨ë“  íŒŒì¼(BOM, ì¬ê³ , ì˜ì—…ê³„íš)ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
                return;
            }
            // ì°½ê³ ê°€ ê°ì§€ë˜ì—ˆëŠ”ë° ì„ íƒ ì•ˆ ëœ ê²½ìš° ê²½ê³ 
            if (allWarehouses.length > 0 && selectedWarehouses.length === 0) {
                alert('ìµœì†Œ 1ê°œ ì´ìƒì˜ ì°½ê³ ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            window.location.href = 'mrp.html';
        }
    </script>
</body>
</html>
